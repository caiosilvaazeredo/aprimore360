{% extends "base.html" %}

{% block title %}Relatórios - Gestão Comercial{% endblock %}
{% block page_title %}Relatórios e Análises{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Report Types -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card text-center" style="cursor: pointer;" onclick="selectReport('vendas')">
                <div class="icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin: 0 auto;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h5 class="mt-3">Relatório de Vendas</h5>
                <p class="text-muted small">Análise completa das vendas</p>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center" style="cursor: pointer;" onclick="selectReport('clientes')">
                <div class="icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin: 0 auto;">
                    <i class="fas fa-users"></i>
                </div>
                <h5 class="mt-3">Relatório de Clientes</h5>
                <p class="text-muted small">Análise de carteira</p>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center" style="cursor: pointer;" onclick="selectReport('produtos')">
                <div class="icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin: 0 auto;">
                    <i class="fas fa-box"></i>
                </div>
                <h5 class="mt-3">Relatório de Produtos</h5>
                <p class="text-muted small">Performance por produto</p>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center" style="cursor: pointer;" onclick="selectReport('comissoes')">
                <div class="icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin: 0 auto;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <h5 class="mt-3">Relatório de Comissões</h5>
                <p class="text-muted small">Cálculo de comissões</p>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="mb-3">Filtros do Relatório</h5>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="dataInicio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="dataFim">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" id="filterCliente">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-gradient w-100" onclick="generateReport()">
                            <i class="fas fa-play"></i> Gerar Relatório
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Results -->
    <div id="reportResults" style="display: none;">
        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="stat-card">
                    <h5 class="mb-3" id="chartTitle">Gráfico</h5>
                    <div style="position: relative; height: 350px;">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <h5 class="mb-3">Resumo</h5>
                    <div id="reportSummary">
                        <!-- Summary will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="custom-table">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Dados Detalhados</h5>
                <div>
                    <button class="btn btn-outline-primary" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-danger" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead id="reportTableHead">
                        <tr>
                            <th>Carregando...</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <tr>
                            <td>Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let reportChart;
    let currentReportType = 'vendas';
    
    // Select Report Type
    function selectReport(type) {
        currentReportType = type;
        showToast(`Relatório de ${type} selecionado`, 'info');
    }
    
    // Generate Report
    async function generateReport() {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const cliente = document.getElementById('filterCliente').value;
        
        if (!dataInicio || !dataFim) {
            showToast('Selecione o período do relatório', 'warning');
            return;
        }
        
        try {
            showLoading();
            
            // Build query params
            const params = new URLSearchParams({
                dataInicio,
                dataFim,
                tipo: currentReportType
            });
            
            if (cliente) params.append('cliente', cliente);
            
            const response = await fetch(`/api/relatorios/vendas?${params}`);
            const data = await response.json();
            
            // Show results
            document.getElementById('reportResults').style.display = 'block';
            
            // Update chart
            updateReportChart(data);
            
            // Update summary
            updateReportSummary(data);
            
            // Update table
            updateReportTable(data);
            
        } catch (error) {
            console.error('Erro ao gerar relatório:', error);
            showToast('Erro ao gerar relatório', 'error');
        } finally {
            hideLoading();
        }
    }
    
    // Update Report Chart
    function updateReportChart(data) {
        const ctx = document.getElementById('reportChart');
        if (!ctx) return;
        
        // Generate sample data
        const labels = [];
        const values = [];
        
        for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(date.getDate() - (29 - i));
            labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            values.push(Math.floor(Math.random() * 15000) + 3000);
        }
        
        // Update chart title
        document.getElementById('chartTitle').textContent = `Gráfico de ${currentReportType.charAt(0).toUpperCase() + currentReportType.slice(1)}`;
        
        // Destroy existing chart
        if (reportChart) {
            reportChart.destroy();
        }
        
        reportChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Vendas',
                    data: values,
                    borderColor: 'rgba(102, 126, 234, 0.8)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Update Report Summary
    function updateReportSummary(data) {
        // Calculate from chart data
        const values = reportChart.data.datasets[0].data;
        const total = values.reduce((sum, v) => sum + v, 0);
        const average = total / values.length;
        
        document.getElementById('reportSummary').innerHTML = `
            <div class="mb-3">
                <label class="small text-muted">Total de Vendas</label>
                <h4 class="mb-0">${formatCurrency(total)}</h4>
            </div>
            <div class="mb-3">
                <label class="small text-muted">Média Diária</label>
                <h4 class="mb-0">${formatCurrency(average)}</h4>
            </div>
            <div class="mb-3">
                <label class="small text-muted">Número de Pedidos</label>
                <h4 class="mb-0">127</h4>
            </div>
            <div>
                <label class="small text-muted">Ticket Médio</label>
                <h4 class="mb-0">${formatCurrency(total / 127)}</h4>
            </div>
        `;
    }
    
    // Update Report Table
    function updateReportTable(data) {
        document.getElementById('reportTableHead').innerHTML = `
            <tr>
                <th>Data</th>
                <th>Nº Pedido</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Comissão</th>
                <th>Status</th>
            </tr>
        `;
        
        // Generate sample table data
        const tbody = document.getElementById('reportTableBody');
        const rows = [];
        
        for (let i = 0; i < 15; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const valor = Math.floor(Math.random() * 5000) + 1000;
            
            rows.push(`
                <tr>
                    <td>${formatDate(date.toISOString().split('T')[0])}</td>
                    <td>#${1000 + i}</td>
                    <td>Cliente ${i + 1}</td>
                    <td><strong>${formatCurrency(valor)}</strong></td>
                    <td class="text-success">${formatCurrency(valor * 0.05)}</td>
                    <td>
                        <span class="badge-status badge-active">
                            Aprovado
                        </span>
                    </td>
                </tr>
            `);
        }
        
        tbody.innerHTML = rows.join('');
    }
    
    // Export Report
    function exportReport(format) {
        showToast(`Exportando relatório em formato ${format.toUpperCase()}...`, 'info');
        // Implementation would go here
    }
    
    // Load Clientes for filter
    async function loadClientes() {
        try {
            const response = await fetch('/api/clientes');
            const clientes = await response.json();
            
            const select = document.getElementById('filterCliente');
            select.innerHTML = '<option value="">Todos</option>';
            
            clientes.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.fantasia || c.razaoSocial;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates (last 30 days)
        const hoje = new Date();
        const trintaDiasAtras = new Date();
        trintaDiasAtras.setDate(hoje.getDate() - 30);
        
        document.getElementById('dataInicio').value = trintaDiasAtras.toISOString().split('T')[0];
        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
        
        // Load clientes
        loadClientes();
    });
</script>
{% endblock %}