{% extends "base.html" %}

{% block title %}Agenda - ComercialPRO{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Header estilo Teams -->
    <div class="teams-header">
        <div class="header-left">
            <i class="fas fa-calendar-alt header-icon"></i>
            <div>
                <h1 class="header-title">Agenda</h1>
                <p class="header-subtitle">Gerencie seus compromissos e reuni√µes</p>
            </div>
        </div>
        <button class="btn-teams-primary" onclick="openCompromissoModal()">
            <i class="fas fa-plus"></i>
            Novo Compromisso
        </button>
    </div>

    <!-- Calendar Container -->
    <div class="teams-card">
        <div id="calendar"></div>
    </div>
</div>

<!-- Modal Novo/Editar Compromisso -->
<div class="modal fade" id="compromissoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content teams-modal">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="compromissoModalTitle">
                    <i class="fas fa-calendar-plus me-2 text-primary"></i>Novo Compromisso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="compromissoForm">
                    <input type="hidden" id="compromissoId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">T√≠tulo *</label>
                        <input type="text" class="form-control teams-input" id="titulo" required 
                               placeholder="Ex: Visita ao cliente">
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tipo *</label>
                            <select class="form-select teams-input" id="tipo" required>
                                <option value="visita">üöó Visita</option>
                                <option value="reuniao">ü§ù Reuni√£o</option>
                                <option value="ligacao">üìû Liga√ß√£o</option>
                                <option value="entrega">üöö Entrega</option>
                                <option value="outro">üìã Outro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cliente</label>
                            <select class="form-select teams-input" id="clienteId">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Data *</label>
                            <input type="date" class="form-control teams-input" id="data" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Hora In√≠cio *</label>
                            <input type="time" class="form-control teams-input" id="horaInicio" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Hora Fim</label>
                            <input type="time" class="form-control teams-input" id="horaFim">
                        </div>
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <label class="form-label fw-semibold">Local</label>
                        <input type="text" class="form-control teams-input" id="local" 
                               placeholder="Endere√ßo ou link da reuni√£o">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Observa√ß√µes</label>
                        <textarea class="form-control teams-input" id="observacoes" rows="3" 
                                  placeholder="Adicione detalhes sobre o compromisso"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Status</label>
                        <select class="form-select teams-input" id="statusCompromisso">
                            <option value="pendente">Pendente</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 gap-2">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn-teams-danger" id="btnDeleteCompromisso" 
                        onclick="deleteCompromisso()" style="display:none;">
                    <i class="fas fa-trash me-2"></i>Excluir
                </button>
                <button type="button" class="btn-teams-primary" onclick="saveCompromisso()">
                    <i class="fas fa-save me-2"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.modern-container {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

.teams-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-icon {
    font-size: 32px;
    color: #6264A7;
}

.header-title {
    font-size: 28px;
    font-weight: 600;
    color: #252423;
    margin: 0;
}

.header-subtitle {
    color: #616161;
    margin: 4px 0 0 0;
    font-size: 14px;
}

.btn-teams-primary {
    background: #6264A7;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-teams-primary:hover {
    background: #5558a5;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(98, 100, 167, 0.3);
}

.btn-teams-danger {
    background: #C4314B;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-teams-danger:hover {
    background: #a82840;
}

.teams-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    padding: 24px;
}

.teams-modal .modal-content {
    border: none;
    border-radius: 8px;
    box-shadow: 0 25.6px 57.6px rgba(0,0,0,0.22);
}

.teams-input {
    border: 1px solid #E1DFDD;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.teams-input:focus {
    border-color: #6264A7;
    box-shadow: 0 0 0 1px #6264A7;
}

/* FullCalendar Styling */
#calendar {
    font-family: 'Segoe UI', Tahoma, sans-serif;
}

.fc {
    --fc-border-color: #E1DFDD;
    --fc-button-bg-color: #6264A7;
    --fc-button-border-color: #6264A7;
    --fc-button-hover-bg-color: #5558a5;
    --fc-button-active-bg-color: #4a4d9b;
    --fc-today-bg-color: rgba(98, 100, 167, 0.1);
}

.fc-toolbar-title {
    font-size: 20px !important;
    font-weight: 600 !important;
    color: #252423 !important;
}

.fc-button {
    border-radius: 4px !important;
    font-weight: 600 !important;
    text-transform: none !important;
    padding: 8px 16px !important;
}

.fc-event {
    border-radius: 4px !important;
    padding: 4px 8px !important;
    border: none !important;
    font-weight: 500 !important;
}

.fc-event:hover {
    filter: brightness(0.95);
    cursor: pointer;
}

.event-visita { background-color: #6264A7 !important; }
.event-reuniao { background-color: #10B981 !important; }
.event-ligacao { background-color: #F59E0B !important; }
.event-entrega { background-color: #3B82F6 !important; }
.event-outro { background-color: #6B7280 !important; }
</style>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/pt-br.global.min.js"></script>

<script>
let calendar;
let compromissoModal;
let compromissos = [];
let clientes = [];

document.addEventListener('DOMContentLoaded', function() {
    compromissoModal = new bootstrap.Modal(document.getElementById('compromissoModal'));
    initCalendar();
    loadClientes();
    loadCompromissos();
});

function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today: 'Hoje',
            month: 'M√™s',
            week: 'Semana',
            day: 'Dia'
        },
        height: 'auto',
        navLinks: true,
        editable: true,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        
        select: function(info) {
            openCompromissoModal(info.startStr);
        },
        
        eventClick: function(info) {
            editCompromisso(info.event.id);
        },
        
        eventDrop: function(info) {
            updateCompromissoDate(info.event);
        }
    });
    
    calendar.render();
}

async function loadClientes() {
    try {
        const response = await fetch('/api/clientes');
        clientes = await response.json();
        
        const select = document.getElementById('clienteId');
        clientes.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.fantasia || c.razaoSocial;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
    }
}

async function loadCompromissos() {
    try {
        const response = await fetch('/api/compromissos');
        if (!response.ok) {
            console.error('Erro ao carregar compromissos:', response.status);
            return;
        }
        
        compromissos = await response.json();
        
        calendar.removeAllEvents();
        
        compromissos.forEach(c => {
            let start = c.data;
            let end = c.data;
            
            if (c.horaInicio) {
                start += 'T' + c.horaInicio;
                end += 'T' + (c.horaFim || c.horaInicio);
            }
            
            calendar.addEvent({
                id: c.id,
                title: c.titulo,
                start: start,
                end: end,
                className: 'event-' + (c.tipo || 'outro'),
                extendedProps: c
            });
        });
    } catch (error) {
        console.error('Erro ao carregar compromissos:', error);
    }
}

function openCompromissoModal(date = null) {
    document.getElementById('compromissoForm').reset();
    document.getElementById('compromissoId').value = '';
    document.getElementById('compromissoModalTitle').innerHTML = 
        '<i class="fas fa-calendar-plus me-2 text-primary"></i>Novo Compromisso';
    document.getElementById('btnDeleteCompromisso').style.display = 'none';
    
    if (date) {
        document.getElementById('data').value = date;
    } else {
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
    }
    
    document.getElementById('horaInicio').value = '09:00';
    document.getElementById('statusCompromisso').value = 'pendente';
    
    compromissoModal.show();
}

function editCompromisso(id) {
    const c = compromissos.find(comp => comp.id === id);
    if (!c) return;
    
    document.getElementById('compromissoId').value = id;
    document.getElementById('titulo').value = c.titulo || '';
    document.getElementById('tipo').value = c.tipo || 'outro';
    document.getElementById('data').value = c.data || '';
    document.getElementById('horaInicio').value = c.horaInicio || '';
    document.getElementById('horaFim').value = c.horaFim || '';
    document.getElementById('clienteId').value = c.clienteId || '';
    document.getElementById('local').value = c.local || '';
    document.getElementById('observacoes').value = c.observacoes || '';
    document.getElementById('statusCompromisso').value = c.status || 'pendente';
    
    document.getElementById('compromissoModalTitle').innerHTML = 
        '<i class="fas fa-edit me-2 text-primary"></i>Editar Compromisso';
    document.getElementById('btnDeleteCompromisso').style.display = 'inline-flex';
    
    compromissoModal.show();
}

async function saveCompromisso() {
    const id = document.getElementById('compromissoId').value;
    
    const data = {
        titulo: document.getElementById('titulo').value,
        tipo: document.getElementById('tipo').value,
        data: document.getElementById('data').value,
        horaInicio: document.getElementById('horaInicio').value,
        horaFim: document.getElementById('horaFim').value || null,
        clienteId: document.getElementById('clienteId').value || null,
        local: document.getElementById('local').value || null,
        observacoes: document.getElementById('observacoes').value || null,
        status: document.getElementById('statusCompromisso').value
    };
    
    if (!data.titulo || !data.data || !data.horaInicio) {
        alert('Preencha os campos obrigat√≥rios');
        return;
    }
    
    try {
        const url = id ? `/api/compromissos/${id}` : '/api/compromissos';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            compromissoModal.hide();
            showToast(id ? 'Compromisso atualizado!' : 'Compromisso criado!', 'success');
            loadCompromissos();
        } else {
            const error = await response.json();
            showToast(error.error || 'Erro ao salvar', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar compromisso', 'danger');
    }
}

async function deleteCompromisso() {
    const id = document.getElementById('compromissoId').value;
    if (!id || !confirm('Tem certeza que deseja excluir?')) return;
    
    try {
        const response = await fetch(`/api/compromissos/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
            compromissoModal.hide();
            showToast('Compromisso exclu√≠do!', 'success');
            loadCompromissos();
        } else {
            showToast('Erro ao excluir', 'danger');
        }
    } catch (error) {
        showToast('Erro ao excluir', 'danger');
    }
}

async function updateCompromissoDate(event) {
    const id = event.id;
    const newDate = event.start.toISOString().split('T')[0];
    
    try {
        await fetch(`/api/compromissos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: newDate })
        });
        
        showToast('Data atualizada!', 'success');
        loadCompromissos();
    } catch (error) {
        console.error('Erro:', error);
    }
}

function showToast(message, type) {
    const colors = {
        success: '#10B981',
        danger: '#C4314B',
        warning: '#F59E0B'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        background: ${colors[type] || '#6264A7'};
        color: white;
        padding: 16px 24px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600;
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}