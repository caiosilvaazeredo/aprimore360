{% extends "base.html" %}

{% block title %}Dashboard - ComercialPRO{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Header -->
    <div class="teams-header mb-4">
        <div class="header-left">
            <i class="fas fa-chart-line header-icon"></i>
            <div>
                <h1 class="header-title">Dashboard</h1>
                <p class="header-subtitle">VisÃ£o geral do seu desempenho</p>
            </div>
        </div>
        <button class="btn-teams-primary" onclick="loadDashboard()">
            <i class="fas fa-sync-alt"></i>
            Atualizar
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card-large">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div>
                    <div class="stat-label">Vendas do MÃªs</div>
                    <div class="stat-value" id="vendasMes">R$ 0</div>
                    <div class="stat-change" id="vendasChange">0%</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card-large">
                <div class="stat-icon bg-success">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <div class="stat-label">Total de Clientes</div>
                    <div class="stat-value" id="totalClientes">0</div>
                    <div class="stat-change" id="clientesChange">+0 novos</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card-large">
                <div class="stat-icon bg-warning">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div>
                    <div class="stat-label">Compromissos Hoje</div>
                    <div class="stat-value" id="compromissosHoje">0</div>
                    <div class="stat-change" id="pendentesText">0 pendentes</div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card-large">
                <div class="stat-icon bg-danger">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div>
                    <div class="stat-label">Meta do MÃªs</div>
                    <div class="stat-value" id="metaMes">0%</div>
                    <div class="stat-change" id="metaStatus">Sem meta</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Vendas Chart -->
        <div class="col-md-8">
            <div class="teams-card">
                <h6 class="card-title">
                    <i class="fas fa-chart-bar me-2"></i>Vendas nos Ãšltimos 6 Meses
                </h6>
                <div id="vendasChartContainer" style="height: 300px;">
                    <canvas id="vendasChart"></canvas>
                </div>
                <div id="noVendasData" class="empty-state" style="display: none;">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5>Sem dados de vendas</h5>
                    <p class="text-muted">Comece a registrar pedidos para ver seus grÃ¡ficos aqui</p>
                    <a href="/pedidos" class="btn-teams-primary">
                        <i class="fas fa-plus me-2"></i>Criar Pedido
                    </a>
                </div>
            </div>
        </div>

        <!-- Status Clientes -->
        <div class="col-md-4">
            <div class="teams-card">
                <h6 class="card-title">
                    <i class="fas fa-pie-chart me-2"></i>Status dos Clientes
                </h6>
                <div id="clientesChartContainer" style="height: 300px;">
                    <canvas id="clientesChart"></canvas>
                </div>
                <div id="noClientesData" class="empty-state" style="display: none;">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>Sem clientes</h5>
                    <p class="text-muted">Cadastre seus primeiros clientes</p>
                    <a href="/clientes" class="btn-teams-primary">
                        <i class="fas fa-plus me-2"></i>Cadastrar Cliente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- PrÃ³ximos Compromissos e Ãšltimos Pedidos -->
    <div class="row g-3 mt-3">
        <div class="col-md-6">
            <div class="teams-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>PrÃ³ximos Compromissos
                    </h6>
                    <a href="/agenda" class="text-primary">Ver todos</a>
                </div>
                <div id="proximosCompromissos">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                <div id="noCompromissosData" class="empty-state" style="display: none;">
                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                    <h5>Sem compromissos</h5>
                    <p class="text-muted">Agende suas prÃ³ximas visitas</p>
                    <a href="/agenda" class="btn-teams-primary">
                        <i class="fas fa-plus me-2"></i>Criar Compromisso
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="teams-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>Ãšltimos Pedidos
                    </h6>
                    <a href="/pedidos" class="text-primary">Ver todos</a>
                </div>
                <div id="ultimosPedidos">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                <div id="noPedidosData" class="empty-state" style="display: none;">
                    <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                    <h5>Sem pedidos</h5>
                    <p class="text-muted">Crie seu primeiro pedido</p>
                    <a href="/pedidos" class="btn-teams-primary">
                        <i class="fas fa-plus me-2"></i>Novo Pedido
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modern-container {
    padding: 24px;
    max-width: 1600px;
    margin: 0 auto;
}

.teams-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-icon {
    font-size: 32px;
    color: #6264A7;
}

.header-title {
    font-size: 28px;
    font-weight: 600;
    color: #252423;
    margin: 0;
}

.header-subtitle {
    color: #616161;
    margin: 4px 0 0 0;
    font-size: 14px;
}

.btn-teams-primary {
    background: #6264A7;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-teams-primary:hover {
    background: #5558a5;
    color: white;
}

.stat-card-large {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-icon.bg-primary { background: #6264A7; }
.stat-icon.bg-success { background: #10B981; }
.stat-icon.bg-warning { background: #F59E0B; }
.stat-icon.bg-danger { background: #EF4444; }

.stat-label {
    font-size: 12px;
    color: #616161;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #252423;
}

.stat-change {
    font-size: 13px;
    color: #10B981;
    margin-top: 4px;
}

.teams-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    padding: 24px;
}

.card-title {
    font-weight: 600;
    color: #252423;
    display: flex;
    align-items: center;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-state h5 {
    color: #252423;
    font-weight: 600;
    margin-bottom: 8px;
}

.empty-state p {
    color: #616161;
    margin-bottom: 20px;
}

.compromisso-item, .pedido-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 4px solid #6264A7;
    background: #f8f9fa;
}

.compromisso-item h6, .pedido-item h6 {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 600;
}

.compromisso-item p, .pedido-item p {
    margin: 0;
    font-size: 13px;
    color: #616161;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let vendasChart = null;
let clientesChart = null;

document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
});

async function loadDashboard() {
    try {
        // Stats
        await loadStats();
        
        // Charts
        await loadVendasChart();
        await loadClientesChart();
        
        // Lists
        await loadProximosCompromissos();
        await loadUltimosPedidos();
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const stats = await response.json();
        
        document.getElementById('vendasMes').textContent = 
            `R$ ${(stats.vendasMes || 0).toLocaleString('pt-BR')}`;
        document.getElementById('totalClientes').textContent = stats.totalClientes || 0;
        document.getElementById('compromissosHoje').textContent = stats.compromissosHoje || 0;
        document.getElementById('metaMes').textContent = `${stats.metaMes || 0}%`;
        
        document.getElementById('vendasChange').textContent = 
            `${stats.vendasChange >= 0 ? '+' : ''}${stats.vendasChange || 0}%`;
        document.getElementById('clientesChange').textContent = 
            `+${stats.clientesNovos || 0} novos`;
        document.getElementById('pendentesText').textContent = 
            `${stats.compromissosPendentes || 0} pendentes`;
        document.getElementById('metaStatus').textContent = 
            stats.metaMes >= 100 ? 'Meta atingida! ðŸŽ‰' : 'Em progresso';
        
    } catch (error) {
        console.error('Erro ao carregar stats:', error);
    }
}

async function loadVendasChart() {
    try {
        const response = await fetch('/api/dashboard/vendas-mes');
        const data = await response.json();
        
        if (!data || data.length === 0) {
            document.getElementById('vendasChartContainer').style.display = 'none';
            document.getElementById('noVendasData').style.display = 'block';
            return;
        }
        
        document.getElementById('vendasChartContainer').style.display = 'block';
        document.getElementById('noVendasData').style.display = 'none';
        
        const ctx = document.getElementById('vendasChart');
        
        if (vendasChart) {
            vendasChart.destroy();
        }
        
        vendasChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.mes),
                datasets: [{
                    label: 'Vendas (R$)',
                    data: data.map(d => d.valor),
                    borderColor: '#6264A7',
                    backgroundColor: 'rgba(98, 100, 167, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar grÃ¡fico de vendas:', error);
        document.getElementById('vendasChartContainer').style.display = 'none';
        document.getElementById('noVendasData').style.display = 'block';
    }
}

async function loadClientesChart() {
    try {
        const response = await fetch('/api/dashboard/clientes-status');
        const data = await response.json();
        
        if (!data || data.length === 0) {
            document.getElementById('clientesChartContainer').style.display = 'none';
            document.getElementById('noClientesData').style.display = 'block';
            return;
        }
        
        document.getElementById('clientesChartContainer').style.display = 'block';
        document.getElementById('noClientesData').style.display = 'none';
        
        const ctx = document.getElementById('clientesChart');
        
        if (clientesChart) {
            clientesChart.destroy();
        }
        
        clientesChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.status),
                datasets: [{
                    data: data.map(d => d.quantidade),
                    backgroundColor: ['#10B981', '#6264A7', '#F59E0B', '#6B7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    } catch (error) {
        console.error('Erro ao carregar grÃ¡fico de clientes:', error);
        document.getElementById('clientesChartContainer').style.display = 'none';
        document.getElementById('noClientesData').style.display = 'block';
    }
}

async function loadProximosCompromissos() {
    try {
        const response = await fetch('/api/compromissos?limit=5');
        const compromissos = await response.json();
        
        const container = document.getElementById('proximosCompromissos');
        
        if (!compromissos || compromissos.length === 0) {
            container.style.display = 'none';
            document.getElementById('noCompromissosData').style.display = 'block';
            return;
        }
        
        container.style.display = 'block';
        document.getElementById('noCompromissosData').style.display = 'none';
        
        container.innerHTML = compromissos.slice(0, 5).map(c => `
            <div class="compromisso-item">
                <h6>${c.titulo}</h6>
                <p><i class="fas fa-calendar me-2"></i>${c.data} Ã s ${c.horaInicio || c.hora}</p>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Erro ao carregar compromissos:', error);
        document.getElementById('proximosCompromissos').style.display = 'none';
        document.getElementById('noCompromissosData').style.display = 'block';
    }
}

async function loadUltimosPedidos() {
    try {
        const response = await fetch('/api/pedidos?limit=5');
        const pedidos = await response.json();
        
        const container = document.getElementById('ultimosPedidos');
        
        if (!pedidos || pedidos.length === 0) {
            container.style.display = 'none';
            document.getElementById('noPedidosData').style.display = 'block';
            return;
        }
        
        container.style.display = 'block';
        document.getElementById('noPedidosData').style.display = 'none';
        
        container.innerHTML = pedidos.slice(0, 5).map(p => `
            <div class="pedido-item">
                <h6>Pedido #${p.id.slice(-6)}</h6>
                <p>
                    <i class="fas fa-user me-2"></i>${p.clienteNome || 'Cliente'}
                    <span class="ms-3"><i class="fas fa-dollar-sign me-1"></i>R$ ${(p.valorTotal || 0).toFixed(2)}</span>
                </p>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        document.getElementById('ultimosPedidos').style.display = 'none';
        document.getElementById('noPedidosData').style.display = 'block';
    }
}
</script>
{% endblock %}