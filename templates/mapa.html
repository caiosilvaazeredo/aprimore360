{% extends "base.html" %}

{% block title %}Mapa de Clientes - ComercialPRO{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1"><i class="fas fa-map-marked-alt me-2"></i>Mapa de Clientes</h4>
            <p class="text-muted mb-0">Visualize e otimize suas rotas de visitas</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="toggleView()" id="btnToggleView">
                <i class="fas fa-project-diagram me-2"></i>Ver Polígono
            </button>
            <button class="btn btn-primary" onclick="loadClientes()">
                <i class="fas fa-sync-alt me-2"></i>Atualizar
            </button>
        </div>
    </div>

    <div class="row g-3">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-users me-2"></i>Clientes</h6>
                    
                    <input type="text" class="form-control mb-3" id="searchCliente" 
                           placeholder="Buscar cliente..." onkeyup="filterClientes()">
                    
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            Selecionar Todos
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                            Limpar Seleção
                        </button>
                    </div>
                    
                    <div id="clientesList" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Carregando...</p>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Selecionados:</span>
                            <strong id="selectedCount">0</strong>
                        </div>
                        <button class="btn btn-success w-100" onclick="otimizarRota()" id="btnOtimizar" disabled>
                            <i class="fas fa-route me-2"></i>Otimizar Rota
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Area -->
        <div class="col-md-9">
            <!-- Map View -->
            <div class="card" id="mapView">
                <div id="map" style="height: 600px; border-radius: 10px;"></div>
            </div>
            
            <!-- Polygon View -->
            <div class="card" id="polygonView" style="display: none;">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h5><i class="fas fa-project-diagram me-2"></i>Visualização de Polígono</h5>
                        <p class="text-muted">Representação geométrica das distâncias entre clientes</p>
                    </div>
                    <svg id="polygonSvg" width="100%" height="500"></svg>
                    <div id="polygonInfo" class="mt-4"></div>
                </div>
            </div>
            
            <!-- Route Info -->
            <div class="card mt-3" id="routeInfo" style="display: none;">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>Informações da Rota
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="stat-box">
                                <i class="fas fa-road text-primary"></i>
                                <div>
                                    <div class="stat-value" id="routeDistance">0 km</div>
                                    <div class="stat-label">Distância Total</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-box">
                                <i class="fas fa-clock text-success"></i>
                                <div>
                                    <div class="stat-value" id="routeTime">0 min</div>
                                    <div class="stat-label">Tempo Estimado</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-box">
                                <i class="fas fa-map-marker-alt text-danger"></i>
                                <div>
                                    <div class="stat-value" id="routeStops">0</div>
                                    <div class="stat-label">Paradas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
.card {
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: none;
}

.card-title {
    font-weight: 600;
    color: #1e293b;
}

.cliente-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 10px;
}

.cliente-item:hover {
    background: #f8fafc;
    border-color: #e2e8f0;
}

.cliente-item.selected {
    background: #e0e7ff;
    border-color: #6366f1;
}

.cliente-item input[type="checkbox"] {
    accent-color: #6366f1;
    width: 18px;
    height: 18px;
}

.cliente-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
}

.cliente-info p {
    margin: 0;
    font-size: 12px;
    color: #64748b;
}

.stat-box {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
}

.stat-box i {
    font-size: 28px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
}

.stat-label {
    font-size: 12px;
    color: #64748b;
    text-transform: uppercase;
}

#map {
    z-index: 1;
}

.leaflet-popup-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.leaflet-popup-content h6 {
    margin: 0 0 8px 0;
    font-weight: 600;
}

.leaflet-popup-content p {
    margin: 4px 0;
    font-size: 13px;
}
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let clientes = [];
let selectedClientes = [];
let markers = [];
let routeLine = null;
let currentView = 'map';

document.addEventListener('DOMContentLoaded', function() {
    initMap();
    loadClientes();
});

function initMap() {
    map = L.map('map').setView([-23.5505, -46.6333], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
}

async function loadClientes() {
    try {
        console.log('[MAPA] Carregando clientes...');
        
        const response = await fetch('/api/mapa/clientes');
        
        console.log('[MAPA] Status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[MAPA] Dados recebidos:', data);
        
        // Tratamento: pode vir {clientes: []} ou diretamente []
        if (Array.isArray(data)) {
            clientes = data;
        } else if (data.clientes && Array.isArray(data.clientes)) {
            clientes = data.clientes;
        } else {
            console.warn('[MAPA] Formato inesperado:', data);
            clientes = [];
        }
        
        console.log('[MAPA] Total de clientes:', clientes.length);
        
        renderClientesList();
        addMarkersToMap();
        
    } catch (error) {
        console.error('[ERRO] loadClientes:', error);
        
        document.getElementById('clientesList').innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <p class="text-danger mb-2">Erro ao carregar clientes</p>
                <small class="text-muted d-block mb-2">${error.message}</small>
                <button class="btn btn-sm btn-primary" onclick="loadClientes()">
                    <i class="fas fa-sync-alt me-1"></i>Tentar Novamente
                </button>
                <a href="/clientes" class="btn btn-sm btn-outline-primary mt-2 d-block">
                    <i class="fas fa-plus me-1"></i>Cadastrar Cliente
                </a>
            </div>
        `;
    }
}

function renderClientesList() {
    const container = document.getElementById('clientesList');
    
    if (!Array.isArray(clientes)) {
        console.error('[ERRO] clientes não é um array:', clientes);
        clientes = [];
    }
    
    if (clientes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>Nenhum cliente com localização</p>
                <a href="/clientes" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i>Cadastrar Cliente
                </a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = clientes.map(c => `
        <div class="cliente-item ${selectedClientes.includes(c.id) ? 'selected' : ''}" 
             onclick="toggleCliente('${c.id}')">
            <input type="checkbox" ${selectedClientes.includes(c.id) ? 'checked' : ''} 
                   onclick="event.stopPropagation(); toggleCliente('${c.id}')">
            <div class="cliente-info">
                <h6>${c.nome || 'Sem nome'}</h6>
                <p><i class="fas fa-map-marker-alt me-1"></i>${(c.endereco || 'Sem endereço').substring(0, 30)}...</p>
            </div>
        </div>
    `).join('');
    
    updateSelectedCount();
}

function filterClientes() {
    const search = document.getElementById('searchCliente').value.toLowerCase();
    const filtered = clientes.filter(c => 
        (c.nome || '').toLowerCase().includes(search) ||
        (c.endereco || '').toLowerCase().includes(search)
    );
    
    const container = document.getElementById('clientesList');
    container.innerHTML = filtered.map(c => `
        <div class="cliente-item ${selectedClientes.includes(c.id) ? 'selected' : ''}" 
             onclick="toggleCliente('${c.id}')">
            <input type="checkbox" ${selectedClientes.includes(c.id) ? 'checked' : ''}>
            <div class="cliente-info">
                <h6>${c.nome || 'Sem nome'}</h6>
                <p><i class="fas fa-map-marker-alt me-1"></i>${(c.endereco || 'Sem endereço').substring(0, 30)}...</p>
            </div>
        </div>
    `).join('');
}

function addMarkersToMap() {
    // Remove marcadores anteriores
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    
    if (clientes.length === 0) return;
    
    // Adiciona marcadores
    const bounds = [];
    
    clientes.forEach(cliente => {
        if (cliente.latitude && cliente.longitude) {
            const marker = L.marker([cliente.latitude, cliente.longitude], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#6366f1;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16]
                })
            });
            
            marker.bindPopup(`
                <h6>${cliente.nome || 'Sem nome'}</h6>
                <p><i class="fas fa-map-marker-alt me-1"></i>${cliente.endereco || 'Sem endereço'}</p>
                <p><i class="fas fa-phone me-1"></i>${cliente.telefone || 'N/A'}</p>
                ${cliente.totalCompras ? `<p><i class="fas fa-dollar-sign me-1"></i>R$ ${cliente.totalCompras.toLocaleString('pt-BR')}</p>` : ''}
            `);
            
            marker.addTo(map);
            markers.push(marker);
            bounds.push([cliente.latitude, cliente.longitude]);
        }
    });
    
    // Ajusta zoom
    if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

function toggleCliente(id) {
    const index = selectedClientes.indexOf(id);
    if (index > -1) {
        selectedClientes.splice(index, 1);
    } else {
        selectedClientes.push(id);
    }
    renderClientesList();
}

function selectAll() {
    selectedClientes = clientes.map(c => c.id);
    renderClientesList();
}

function deselectAll() {
    selectedClientes = [];
    renderClientesList();
    if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
    }
    document.getElementById('routeInfo').style.display = 'none';
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedClientes.length;
    document.getElementById('btnOtimizar').disabled = selectedClientes.length < 2;
}

async function otimizarRota() {
    if (selectedClientes.length < 2) return;
    
    try {
        const response = await fetch('/api/mapa/otimizar-rota', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clienteIds: selectedClientes })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // Mostra info da rota
        document.getElementById('routeInfo').style.display = 'block';
        document.getElementById('routeDistance').textContent = `${result.distanciaTotal} km`;
        document.getElementById('routeTime').textContent = `${result.tempoEstimado} min`;
        document.getElementById('routeStops').textContent = selectedClientes.length;
        
        // Desenha rota
        drawRoute(result.rota);
        
        showToast('Rota otimizada!', 'success');
        
    } catch (error) {
        console.error('Erro ao otimizar rota:', error);
        showToast('Erro ao otimizar rota: ' + error.message, 'error');
    }
}

function drawRoute(rotaIds) {
    // Remove rota anterior
    if (routeLine) {
        map.removeLayer(routeLine);
    }
    
    // Pega coordenadas
    const coords = rotaIds.map(id => {
        const cliente = clientes.find(c => c.id === id);
        return [cliente.latitude, cliente.longitude];
    });
    
    // Desenha linha
    routeLine = L.polyline(coords, {
        color: '#10b981',
        weight: 4,
        opacity: 0.8
    }).addTo(map);
    
    // Adiciona números nos marcadores
    rotaIds.forEach((id, index) => {
        const cliente = clientes.find(c => c.id === id);
        L.marker([cliente.latitude, cliente.longitude], {
            icon: L.divIcon({
                className: 'route-marker',
                html: `<div style="background:#10b981;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">${index + 1}</div>`,
                iconSize: [28, 28]
            })
        }).addTo(map);
    });
    
    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
}

function toggleView() {
    if (currentView === 'map') {
        document.getElementById('mapView').style.display = 'none';
        document.getElementById('polygonView').style.display = 'block';
        document.getElementById('btnToggleView').innerHTML = '<i class="fas fa-map me-2"></i>Ver Mapa';
        currentView = 'polygon';
        drawPolygon();
    } else {
        document.getElementById('mapView').style.display = 'block';
        document.getElementById('polygonView').style.display = 'none';
        document.getElementById('btnToggleView').innerHTML = '<i class="fas fa-project-diagram me-2"></i>Ver Polígono';
        currentView = 'map';
    }
}

function drawPolygon() {
    const svg = document.getElementById('polygonSvg');
    const width = svg.clientWidth;
    const height = 500;
    
    if (selectedClientes.length < 3) {
        svg.innerHTML = `
            <text x="${width/2}" y="${height/2}" text-anchor="middle" fill="#64748b" font-size="14">
                Selecione pelo menos 3 clientes para visualizar o polígono
            </text>
        `;
        document.getElementById('polygonInfo').innerHTML = '';
        return;
    }
    
    const selected = clientes.filter(c => selectedClientes.includes(c.id));
    
    const lats = selected.map(c => c.latitude);
    const lngs = selected.map(c => c.longitude);
    
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLng = Math.min(...lngs);
    const maxLng = Math.max(...lngs);
    
    const padding = 50;
    
    const points = selected.map(c => {
        const x = padding + ((c.longitude - minLng) / (maxLng - minLng)) * (width - 2 * padding);
        const y = padding + ((maxLat - c.latitude) / (maxLat - minLat)) * (height - 2 * padding);
        return { x, y, nome: c.nome };
    });
    
    const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');
    
    svg.innerHTML = `
        <polygon points="${polygonPoints}" 
                 fill="rgba(99, 102, 241, 0.2)" 
                 stroke="#6366f1" 
                 stroke-width="2" />
        
        ${points.map((p, i) => {
            const nextP = points[(i + 1) % points.length];
            const dist = Math.sqrt(Math.pow(p.x - nextP.x, 2) + Math.pow(p.y - nextP.y, 2));
            const midX = (p.x + nextP.x) / 2;
            const midY = (p.y + nextP.y) / 2;
            
            return `
                <line x1="${p.x}" y1="${p.y}" x2="${nextP.x}" y2="${nextP.y}" 
                      stroke="#6366f1" stroke-width="2" stroke-dasharray="5,5" />
                <circle cx="${p.x}" cy="${p.y}" r="8" fill="#6366f1" />
                <text x="${p.x}" y="${p.y - 15}" text-anchor="middle" 
                      font-size="12" font-weight="600" fill="#1e293b">
                    ${i + 1}. ${(p.nome || 'Cliente').substring(0, 15)}
                </text>
                <text x="${midX}" y="${midY}" text-anchor="middle" 
                      font-size="10" fill="#64748b" font-weight="600">
                    ${dist.toFixed(0)}px
                </text>
            `;
        }).join('')}
    `;
    
    // Info
    let html = '<h6 class="mb-3">Ordem de Visitas:</h6><ol class="list-group">';
    points.forEach((p, i) => {
        html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>${i + 1}.</strong> ${p.nome || 'Cliente'}</span>
                ${i < points.length - 1 ? `<span class="badge bg-primary">→ ${(points[i + 1].nome || 'Cliente').substring(0, 10)}</span>` : ''}
            </li>
        `;
    });
    html += '</ol>';
    document.getElementById('polygonInfo').innerHTML = html;
}

function showToast(message, type) {
    const colors = { success: '#10b981', error: '#ef4444' };
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: ${colors[type] || '#6366f1'}; color: white;
        padding: 16px 24px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}