{% extends "base.html" %}

{% block title %}Clientes - ComercialPRO{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">Gestão de Clientes</h4>
            <p class="text-muted mb-0">Gerencie sua carteira de clientes</p>
        </div>
        <button class="btn btn-primary" onclick="openClienteModal()">
            <i class="fas fa-plus me-2"></i>Novo Cliente
        </button>
    </div>

    <!-- Filters -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchCliente" placeholder="Buscar cliente...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterStatus">
                <option value="">Todos os Status</option>
                <option value="prospecto">Prospecto</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterCategoria">
                <option value="">Todas as Categorias</option>
                <option value="varejo">Varejo</option>
                <option value="atacado">Atacado</option>
                <option value="distribuidor">Distribuidor</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100" onclick="loadClientes()">
                <i class="fas fa-sync-alt me-2"></i>Atualizar
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Contato</th>
                        <th>Endereço</th>
                        <th>Status</th>
                        <th>Última Compra</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="clientesTable">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2 mb-0">Carregando clientes...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo/Editar Cliente -->
<div class="modal fade" id="clienteModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clienteModalTitle">
                    <i class="fas fa-user-plus me-2"></i>Novo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clienteForm">
                    <input type="hidden" id="clienteId">
                    
                    <!-- Dados Básicos -->
                    <h6 class="mb-3"><i class="fas fa-building me-2"></i>Dados da Empresa</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label">Nome Fantasia *</label>
                            <input type="text" class="form-control" id="fantasia" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CNPJ/CPF</label>
                            <input type="text" class="form-control" id="documento">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Razão Social</label>
                            <input type="text" class="form-control" id="razaoSocial">
                        </div>
                    </div>
                    
                    <!-- Contato -->
                    <h6 class="mb-3"><i class="fas fa-phone me-2"></i>Contato</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Responsável</label>
                            <input type="text" class="form-control" id="responsavel">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone *</label>
                            <input type="tel" class="form-control" id="telefone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp</label>
                            <input type="tel" class="form-control" id="whatsapp">
                        </div>
                    </div>
                    
                    <!-- Endereço -->
                    <h6 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Endereço</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep" onblur="buscarCEP()">
                        </div>
                        <div class="col-md-9">
                            <label class="form-label">Endereço *</label>
                            <input type="text" class="form-control" id="endereco" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade">
                        </div>
                    </div>
                    
                    <!-- Botões de Localização -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="usarLocalizacaoAtual()">
                                <i class="fas fa-crosshairs me-2"></i>Usar Minha Localização
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-success w-100" onclick="confirmarEndereco()">
                                <i class="fas fa-map-marker-alt me-2"></i>Confirmar no Mapa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mapa Container -->
                    <div id="mapContainer" style="display: none;" class="mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Arraste o marcador</strong> para ajustar a posição exata
                        </div>
                        <div id="clienteMap" style="height: 350px; border-radius: 8px;"></div>
                        <input type="hidden" id="latitude">
                        <input type="hidden" id="longitude">
                    </div>
                    
                    <!-- Classificação -->
                    <h6 class="mb-3"><i class="fas fa-tags me-2"></i>Classificação</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="prospecto">Prospecto</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="categoria">
                                <option value="varejo">Varejo</option>
                                <option value="atacado">Atacado</option>
                                <option value="distribuidor">Distribuidor</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Frequência de Visita</label>
                            <select class="form-select" id="frequenciaVisita">
                                <option value="semanal">Semanal</option>
                                <option value="quinzenal">Quinzenal</option>
                                <option value="mensal">Mensal</option>
                                <option value="sob_demanda">Sob Demanda</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCliente()">
                    <i class="fas fa-save me-2"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
.card {
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.badge {
    padding: 6px 12px;
    font-weight: 500;
}

.btn-action {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

#mapContainer {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

#clienteMap {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let clientes = [];
let clienteModal;
let clienteMap = null;
let clienteMarker = null;

document.addEventListener('DOMContentLoaded', function() {
    clienteModal = new bootstrap.Modal(document.getElementById('clienteModal'));
    loadClientes();
    
    document.getElementById('searchCliente').addEventListener('input', filterClientes);
    document.getElementById('filterStatus').addEventListener('change', filterClientes);
    document.getElementById('filterCategoria').addEventListener('change', filterClientes);
});

async function loadClientes() {
    try {
        const response = await fetch('/api/clientes');
        clientes = await response.json();
        renderClientes(clientes);
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        document.getElementById('clientesTable').innerHTML = `
            <tr><td colspan="6" class="text-center text-danger py-4">
                Erro ao carregar clientes
            </td></tr>
        `;
    }
}

function renderClientes(clientesArray) {
    const tbody = document.getElementById('clientesTable');
    
    if (clientesArray.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="6" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                Nenhum cliente encontrado
            </td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = clientesArray.map(c => `
        <tr>
            <td>
                <strong>${c.fantasia || c.razaoSocial}</strong>
                ${c.documento ? `<br><small class="text-muted">${c.documento}</small>` : ''}
            </td>
            <td>
                ${c.telefone || '-'}<br>
                <small class="text-muted">${c.email || ''}</small>
            </td>
            <td>
                ${c.endereco ? `${c.endereco}${c.numero ? ', ' + c.numero : ''}<br>${c.cidade || ''}` : '-'}
            </td>
            <td>
                <span class="badge bg-${c.status === 'ativo' ? 'success' : c.status === 'inativo' ? 'danger' : 'warning'}">
                    ${c.status || 'prospecto'}
                </span>
            </td>
            <td>${c.ultimaCompra || 'Nunca'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-action" onclick="editCliente('${c.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info btn-action" onclick="viewMap('${c.id}')" title="Ver no mapa">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-action" onclick="deleteCliente('${c.id}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterClientes() {
    const search = document.getElementById('searchCliente').value.toLowerCase();
    const status = document.getElementById('filterStatus').value;
    const categoria = document.getElementById('filterCategoria').value;
    
    let filtered = clientes.filter(c => {
        const matchSearch = !search || 
            (c.fantasia || '').toLowerCase().includes(search) ||
            (c.razaoSocial || '').toLowerCase().includes(search) ||
            (c.telefone || '').includes(search);
        
        const matchStatus = !status || c.status === status;
        const matchCategoria = !categoria || c.categoria === categoria;
        
        return matchSearch && matchStatus && matchCategoria;
    });
    
    renderClientes(filtered);
}

function openClienteModal() {
    document.getElementById('clienteForm').reset();
    document.getElementById('clienteId').value = '';
    document.getElementById('clienteModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Novo Cliente';
    document.getElementById('mapContainer').style.display = 'none';
    
    if (clienteMap) {
        clienteMap.remove();
        clienteMap = null;
        clienteMarker = null;
    }
    
    clienteModal.show();
}

function editCliente(id) {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return;
    
    document.getElementById('clienteId').value = id;
    document.getElementById('fantasia').value = cliente.fantasia || '';
    document.getElementById('documento').value = cliente.documento || '';
    document.getElementById('razaoSocial').value = cliente.razaoSocial || '';
    document.getElementById('responsavel').value = cliente.responsavel || '';
    document.getElementById('telefone').value = cliente.telefone || '';
    document.getElementById('email').value = cliente.email || '';
    document.getElementById('whatsapp').value = cliente.whatsapp || '';
    document.getElementById('cep').value = cliente.cep || '';
    document.getElementById('endereco').value = cliente.endereco || '';
    document.getElementById('numero').value = cliente.numero || '';
    document.getElementById('bairro').value = cliente.bairro || '';
    document.getElementById('cidade').value = cliente.cidade || '';
    document.getElementById('status').value = cliente.status || 'prospecto';
    document.getElementById('categoria').value = cliente.categoria || 'varejo';
    document.getElementById('frequenciaVisita').value = cliente.frequenciaVisita || 'mensal';
    document.getElementById('observacoes').value = cliente.observacoes || '';
    
    if (cliente.latitude && cliente.longitude) {
        document.getElementById('latitude').value = cliente.latitude;
        document.getElementById('longitude').value = cliente.longitude;
        mostrarMapaCliente(cliente.latitude, cliente.longitude);
    }
    
    document.getElementById('clienteModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Cliente';
    clienteModal.show();
}

async function saveCliente() {
    const id = document.getElementById('clienteId').value;
    
    const endereco = document.getElementById('endereco').value;
    const numero = document.getElementById('numero').value;
    const bairro = document.getElementById('bairro').value;
    const cidade = document.getElementById('cidade').value;
    const cep = document.getElementById('cep').value;
    
    const data = {
        fantasia: document.getElementById('fantasia').value,
        documento: document.getElementById('documento').value,
        razaoSocial: document.getElementById('razaoSocial').value,
        responsavel: document.getElementById('responsavel').value,
        telefone: document.getElementById('telefone').value,
        email: document.getElementById('email').value,
        whatsapp: document.getElementById('whatsapp').value,
        cep: cep,
        endereco: endereco,
        numero: numero,
        bairro: bairro,
        cidade: cidade,
        status: document.getElementById('status').value,
        categoria: document.getElementById('categoria').value,
        frequenciaVisita: document.getElementById('frequenciaVisita').value,
        observacoes: document.getElementById('observacoes').value,
        latitude: document.getElementById('latitude').value || null,
        longitude: document.getElementById('longitude').value || null
    };
    
    try {
        const url = id ? `/api/clientes/${id}` : '/api/clientes';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            clienteModal.hide();
            showToast(id ? 'Cliente atualizado!' : 'Cliente criado!', 'success');
            loadClientes();
        } else {
            const error = await response.json();
            showToast(error.error || 'Erro ao salvar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao salvar cliente:', error);
        showToast('Erro ao salvar cliente', 'danger');
    }
}

async function deleteCliente(id) {
    if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
    
    try {
        const response = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
            showToast('Cliente excluído!', 'success');
            loadClientes();
        } else {
            showToast('Erro ao excluir', 'danger');
        }
    } catch (error) {
        showToast('Erro ao excluir cliente', 'danger');
    }
}

function viewMap(id) {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente || !cliente.latitude || !cliente.longitude) {
        showToast('Cliente sem localização definida', 'warning');
        return;
    }
    
    window.location.href = `/mapa?cliente=${id}`;
}

async function buscarCEP() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length !== 8) return;
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (!data.erro) {
            document.getElementById('endereco').value = data.logradouro;
            document.getElementById('bairro').value = data.bairro;
            document.getElementById('cidade').value = data.localidade;
        }
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
    }
}

function usarLocalizacaoAtual() {
    if (!navigator.geolocation) {
        showToast('Geolocalização não suportada', 'error');
        return;
    }
    
    showToast('Obtendo sua localização...', 'info');
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const data = await response.json();
                
                if (data.address) {
                    document.getElementById('endereco').value = data.address.road || '';
                    document.getElementById('numero').value = data.address.house_number || '';
                    document.getElementById('bairro').value = data.address.suburb || data.address.neighbourhood || '';
                    document.getElementById('cidade').value = data.address.city || data.address.town || '';
                    document.getElementById('cep').value = data.address.postcode || '';
                }
                
                showToast('Localização obtida!', 'success');
                mostrarMapaCliente(lat, lng);
                
            } catch (error) {
                console.error('Erro:', error);
                showToast('Localização obtida! Preencha o endereço.', 'warning');
                mostrarMapaCliente(lat, lng);
            }
        },
        (error) => {
            console.error('Erro de geolocalização:', error);
            showToast('Não foi possível obter localização', 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

async function confirmarEndereco() {
    const endereco = document.getElementById('endereco').value;
    const numero = document.getElementById('numero').value;
    const cidade = document.getElementById('cidade').value;
    
    if (!endereco || !cidade) {
        showToast('Preencha endereço e cidade', 'warning');
        return;
    }
    
    const enderecoCompleto = `${endereco}, ${numero} - ${cidade}`;
    
    try {
        showToast('Buscando localização...', 'info');
        
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(enderecoCompleto)}&format=json&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            mostrarMapaCliente(lat, lng);
            showToast('Localização encontrada!', 'success');
        } else {
            showToast('Endereço não encontrado', 'warning');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao buscar localização', 'error');
    }
}

function mostrarMapaCliente(lat, lng) {
    const container = document.getElementById('mapContainer');
    container.style.display = 'block';
    
    if (!clienteMap) {
        clienteMap = L.map('clienteMap').setView([lat, lng], 16);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(clienteMap);
        
        clienteMarker = L.marker([lat, lng], { draggable: true }).addTo(clienteMap);
        
        clienteMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            document.getElementById('latitude').value = pos.lat;
            document.getElementById('longitude').value = pos.lng;
        });
    } else {
        clienteMap.setView([lat, lng], 16);
        clienteMarker.setLatLng([lat, lng]);
    }
    
    setTimeout(() => {
        clienteMap.invalidateSize();
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function showToast(message, type) {
    const colors = { success: '#10b981', error: '#ef4444', danger: '#ef4444', warning: '#f59e0b', info: '#3b82f6' };
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: ${colors[type] || '#6264A7'}; color: white;
        padding: 16px 24px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 600; animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}