{% extends "base.html" %}

{% block title %}Clientes - ComercialPRO{% endblock %}

{% block content %}
<div class="clientes-content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">Gestão de Clientes</h4>
            <p class="text-muted mb-0">Gerencie sua carteira de clientes</p>
        </div>
        <button class="btn btn-primary" onclick="openClienteModal()">
            <i class="fas fa-plus me-2"></i>Novo Cliente
        </button>
    </div>
    
    <!-- Filtros -->
    <div class="card-custom mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchCliente" placeholder="Buscar cliente..." oninput="filterClientes()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus" onchange="filterClientes()">
                        <option value="">Todos os Status</option>
                        <option value="ativo">Ativos</option>
                        <option value="inativo">Inativos</option>
                        <option value="prospecto">Prospectos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterCategoria" onchange="filterClientes()">
                        <option value="">Todas as Categorias</option>
                        <option value="varejo">Varejo</option>
                        <option value="atacado">Atacado</option>
                        <option value="distribuidor">Distribuidor</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="exportClientes()">
                        <i class="fas fa-download me-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Clientes -->
    <div class="card-custom">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Contato</th>
                        <th>Endereço</th>
                        <th>Status</th>
                        <th>Última Compra</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="clientesTable">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2 mb-0">Carregando clientes...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo/Editar Cliente -->
<div class="modal fade" id="clienteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clienteModalTitle">
                    <i class="fas fa-user-plus me-2"></i>Novo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clienteForm">
                    <input type="hidden" id="clienteId">
                    
                    <!-- Dados Básicos -->
                    <h6 class="mb-3"><i class="fas fa-building me-2"></i>Dados da Empresa</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label">Nome Fantasia *</label>
                            <input type="text" class="form-control" id="fantasia" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CNPJ/CPF</label>
                            <input type="text" class="form-control" id="documento">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Razão Social</label>
                            <input type="text" class="form-control" id="razaoSocial">
                        </div>
                    </div>
                    
                    <!-- Contato -->
                    <h6 class="mb-3"><i class="fas fa-phone me-2"></i>Contato</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Responsável</label>
                            <input type="text" class="form-control" id="responsavel">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone *</label>
                            <input type="tel" class="form-control" id="telefone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp</label>
                            <input type="tel" class="form-control" id="whatsapp">
                        </div>
                    </div>
                    
                    <!-- Endereço -->
                    <h6 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Endereço</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep" onblur="buscarCEP()">
                        </div>
                        <div class="col-md-9">
                            <label class="form-label">Endereço *</label>
                            <input type="text" class="form-control" id="endereco" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade">
                        </div>
                    </div>
                    
                    
                    <!-- Mapa de Confirmação -->
                    <div id="mapContainer">
                        <h6 class="mb-2"><i class="fas fa-map-marked-alt me-2"></i>Confirme a localização no mapa</h6>
                        <div class="map-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Arraste o marcador para ajustar a posição exata
                        </div>
                        <div id="clienteMap"></div>
                        <input type="hidden" id="latitude">
                        <input type="hidden" id="longitude">
                    </div>

                    <!-- Classificação -->
                    <h6 class="mb-3"><i class="fas fa-tags me-2"></i>Classificação</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="prospecto">Prospecto</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="categoria">
                                <option value="varejo">Varejo</option>
                                <option value="atacado">Atacado</option>
                                <option value="distribuidor">Distribuidor</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Frequência de Visita</label>
                            <select class="form-select" id="frequenciaVisita">
                                <option value="semanal">Semanal</option>
                                <option value="quinzenal">Quinzenal</option>
                                <option value="mensal">Mensal</option>
                                <option value="sob_demanda">Sob Demanda</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCliente()">
                    <i class="fas fa-save me-2"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .card-custom {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .table th {
        font-weight: 600;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        border-bottom: 2px solid #f1f5f9;
    }
    
    .table td {
        vertical-align: middle;
        padding: 15px;
    }
    
    .cliente-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        margin-right: 12px;
    }
    
    .cliente-name {
        font-weight: 600;
        color: #1e293b;
    }
    
    .cliente-doc {
        font-size: 0.85rem;
        color: #94a3b8;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-ativo {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .status-inativo {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .status-prospecto {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .btn-action {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    let clientes = [];
    let clienteModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        clienteModal = new bootstrap.Modal(document.getElementById('clienteModal'));
        loadClientes();
    });
    
    async function loadClientes() {
        try {
            const response = await fetch('/api/clientes');
            clientes = await response.json();
            renderClientes(clientes);
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
            showToast('Erro ao carregar clientes', 'danger');
        }
    }
    
    function renderClientes(lista) {
        const tbody = document.getElementById('clientesTable');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum cliente encontrado</p>
                        <button class="btn btn-primary btn-sm" onclick="openClienteModal()">
                            <i class="fas fa-plus me-2"></i>Adicionar primeiro cliente
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = lista.map(c => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="cliente-avatar">${getInitials(c.fantasia)}</div>
                        <div>
                            <div class="cliente-name">${c.fantasia}</div>
                            <div class="cliente-doc">${c.documento || 'Sem documento'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div>${c.responsavel || '-'}</div>
                    <small class="text-muted">${c.telefone || '-'}</small>
                </td>
                <td>
                    <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${c.endereco || '-'}
                    </div>
                    <small class="text-muted">${c.cidade || ''}</small>
                </td>
                <td>
                    <span class="status-badge status-${c.status || 'prospecto'}">
                        ${(c.status || 'prospecto').charAt(0).toUpperCase() + (c.status || 'prospecto').slice(1)}
                    </span>
                </td>
                <td>
                    ${c.ultimaCompra ? new Date(c.ultimaCompra).toLocaleDateString('pt-BR') : 'Nunca'}
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-action me-1" onclick="editCliente('${c.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info btn-action me-1" onclick="viewCliente('${c.id}')" title="Ver detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-action" onclick="deleteCliente('${c.id}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function filterClientes() {
        const search = document.getElementById('searchCliente').value.toLowerCase();
        const status = document.getElementById('filterStatus').value;
        const categoria = document.getElementById('filterCategoria').value;
        
        let filtered = clientes.filter(c => {
            const matchSearch = !search || 
                c.fantasia.toLowerCase().includes(search) ||
                (c.documento && c.documento.includes(search)) ||
                (c.responsavel && c.responsavel.toLowerCase().includes(search));
            const matchStatus = !status || c.status === status;
            const matchCategoria = !categoria || c.categoria === categoria;
            
            return matchSearch && matchStatus && matchCategoria;
        });
        
        renderClientes(filtered);
    }
    
    function openClienteModal() {
        document.getElementById('clienteForm').reset();
        document.getElementById('clienteId').value = '';
        document.getElementById('clienteModalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Novo Cliente';
        clienteModal.show();
    }
    
    async function editCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        if (!cliente) return;
        
        document.getElementById('clienteId').value = id;
        document.getElementById('fantasia').value = cliente.fantasia || '';
        document.getElementById('documento').value = cliente.documento || '';
        document.getElementById('razaoSocial').value = cliente.razaoSocial || '';
        document.getElementById('responsavel').value = cliente.responsavel || '';
        document.getElementById('telefone').value = cliente.telefone || '';
        document.getElementById('email').value = cliente.email || '';
        document.getElementById('whatsapp').value = cliente.whatsapp || '';
        document.getElementById('cep').value = cliente.cep || '';
        document.getElementById('endereco').value = cliente.endereco || '';
        document.getElementById('numero').value = cliente.numero || '';
        document.getElementById('bairro').value = cliente.bairro || '';
        document.getElementById('cidade').value = cliente.cidade || '';
        document.getElementById('status').value = cliente.status || 'prospecto';
        document.getElementById('categoria').value = cliente.categoria || 'varejo';
        document.getElementById('frequenciaVisita').value = cliente.frequenciaVisita || 'mensal';
        document.getElementById('observacoes').value = cliente.observacoes || '';
        
        document.getElementById('clienteModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Cliente';
        clienteModal.show();
    }
    
    async function saveCliente() {
        const id = document.getElementById('clienteId').value;
        
        const data = {
            fantasia: document.getElementById('fantasia').value,
            documento: document.getElementById('documento').value,
            razaoSocial: document.getElementById('razaoSocial').value,
            responsavel: document.getElementById('responsavel').value,
            telefone: document.getElementById('telefone').value,
            email: document.getElementById('email').value,
            whatsapp: document.getElementById('whatsapp').value,
            cep: document.getElementById('cep').value,
            endereco: document.getElementById('endereco').value,
            numero: document.getElementById('numero').value,
            bairro: document.getElementById('bairro').value,
            cidade: document.getElementById('cidade').value,
            status: document.getElementById('status').value,
            categoria: document.getElementById('categoria').value,
            frequenciaVisita: document.getElementById('frequenciaVisita').value,
            observacoes: document.getElementById('observacoes').value
        };
        
        try {
            const url = id ? `/api/clientes/${id}` : '/api/clientes';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                clienteModal.hide();
                showToast(id ? 'Cliente atualizado!' : 'Cliente criado!', 'success');
                loadClientes();
            } else {
                const error = await response.json();
                showToast(error.error || 'Erro ao salvar', 'danger');
            }
        } catch (error) {
            console.error('Erro ao salvar cliente:', error);
            showToast('Erro ao salvar cliente', 'danger');
        }
    }
    
    async function deleteCliente(id) {
        if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
        
        try {
            const response = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
            
            if (response.ok) {
                showToast('Cliente excluído!', 'success');
                loadClientes();
            } else {
                const error = await response.json();
                showToast(error.error || 'Erro ao excluir', 'danger');
            }
        } catch (error) {
            console.error('Erro ao excluir cliente:', error);
            showToast('Erro ao excluir cliente', 'danger');
        }
    }
    
    function viewCliente(id) {
        window.location.href = `/mapa?cliente=${id}`;
    }
    
    async function buscarCEP() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');
        if (cep.length !== 8) return;
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            
            if (!data.erro) {
                document.getElementById('endereco').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
            }
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
        }
    }
    
    function exportClientes() {
        const csv = [
            ['Nome', 'Documento', 'Telefone', 'Email', 'Endereço', 'Cidade', 'Status', 'Categoria'].join(','),
            ...clientes.map(c => [
                c.fantasia,
                c.documento || '',
                c.telefone || '',
                c.email || '',
                c.endereco || '',
                c.cidade || '',
                c.status || '',
                c.categoria || ''
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clientes.csv';
        a.click();
    }
    
    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let clienteMap = null;
let clienteMarker = null;

function usarLocalizacaoAtual() {
    if (!navigator.geolocation) {
        showToast('Geolocalização não suportada pelo navegador', 'error');
        return;
    }
    
    showToast('Obtendo sua localização...', 'info');
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Reverse geocoding para preencher endereço
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const data = await response.json();
                
                if (data.address) {
                    document.getElementById('endereco').value = data.address.road || '';
                    document.getElementById('numero').value = data.address.house_number || '';
                    document.getElementById('bairro').value = data.address.suburb || data.address.neighbourhood || '';
                    document.getElementById('cidade').value = data.address.city || data.address.town || '';
                    document.getElementById('cep').value = data.address.postcode || '';
                }
                
                showToast('Localização obtida! Confirme os dados.', 'success');
                mostrarMapaCliente(lat, lng);
                
            } catch (error) {
                console.error('Erro no reverse geocoding:', error);
                showToast('Localização obtida! Preencha o endereço manualmente.', 'warning');
                mostrarMapaCliente(lat, lng);
            }
        },
        (error) => {
            console.error('Erro de geolocalização:', error);
            showToast('Não foi possível obter sua localização', 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function confirmarEndereco() {
    const endereco = document.getElementById('endereco').value;
    const numero = document.getElementById('numero').value;
    const cidade = document.getElementById('cidade').value;
    const cep = document.getElementById('cep').value;
    
    if (!endereco || !cidade) {
        showToast('Preencha o endereço e cidade primeiro', 'warning');
        return;
    }
    
    const enderecoCompleto = `${endereco}, ${numero} - ${cidade}`;
    
    try {
        showToast('Buscando localização...', 'info');
        
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(enderecoCompleto)}&format=json&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            mostrarMapaCliente(lat, lng);
            showToast('Localização encontrada! Ajuste o marcador se necessário.', 'success');
        } else {
            showToast('Endereço não encontrado. Use "Minha Localização" ou corrija o endereço.', 'warning');
        }
    } catch (error) {
        console.error('Erro ao buscar coordenadas:', error);
        showToast('Erro ao buscar localização', 'error');
    }
}

function mostrarMapaCliente(lat, lng) {
    const container = document.getElementById('mapContainer');
    container.style.display = 'block';
    
    if (!clienteMap) {
        clienteMap = L.map('clienteMap').setView([lat, lng], 16);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(clienteMap);
        
        clienteMarker = L.marker([lat, lng], {
            draggable: true
        }).addTo(clienteMap);
        
        clienteMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            document.getElementById('latitude').value = pos.lat;
            document.getElementById('longitude').value = pos.lng;
        });
    } else {
        clienteMap.setView([lat, lng], 16);
        clienteMarker.setLatLng([lat, lng]);
    }
    
    // Scroll suave até o mapa
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}
</script>
