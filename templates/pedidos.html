{% extends "base.html" %}

{% block title %}Pedidos - ComercialPRO{% endblock %}

{% block content %}
<div class="pedidos-content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">Gestão de Pedidos</h4>
            <p class="text-muted mb-0">Acompanhe seus pedidos e comissões</p>
        </div>
        <button class="btn btn-primary" onclick="openPedidoModal()">
            <i class="fas fa-plus me-2"></i>Novo Pedido
        </button>
    </div>
    
    <!-- Cards de Resumo -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="summary-card">
                <div class="summary-icon" style="background: #667eea;">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="summary-info">
                    <h3 id="totalPedidos">0</h3>
                    <p>Total de Pedidos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <div class="summary-icon" style="background: #10b981;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="summary-info">
                    <h3 id="valorTotal">R$ 0</h3>
                    <p>Valor Total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <div class="summary-icon" style="background: #f59e0b;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-info">
                    <h3 id="pendentes">0</h3>
                    <p>Pendentes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <div class="summary-icon" style="background: #ef4444;">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="summary-info">
                    <h3 id="comissoes">R$ 0</h3>
                    <p>Comissões</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card-custom mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="date" class="form-control" id="dataInicio" onchange="filterPedidos()">
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="dataFim" onchange="filterPedidos()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatusPedido" onchange="filterPedidos()">
                        <option value="">Todos os Status</option>
                        <option value="pendente">Pendente</option>
                        <option value="aprovado">Aprovado</option>
                        <option value="entregue">Entregue</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="exportPedidos()">
                        <i class="fas fa-file-excel me-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Pedidos -->
    <div class="card-custom">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Pedido</th>
                        <th>Cliente</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Comissão</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="pedidosTable">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2 mb-0">Carregando pedidos...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo Pedido -->
<div class="modal fade" id="pedidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>Novo Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pedidoForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cliente *</label>
                            <select class="form-select" id="pedidoCliente" required>
                                <option value="">Selecione um cliente</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data *</label>
                            <input type="date" class="form-control" id="pedidoData" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Comissão (%)</label>
                            <input type="number" class="form-control" id="pedidoComissao" value="5" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    
                    <!-- Itens do Pedido -->
                    <h6 class="mb-3"><i class="fas fa-list me-2"></i>Itens do Pedido</h6>
                    <div id="itensPedido">
                        <div class="item-row mb-3">
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <input type="text" class="form-control" placeholder="Descrição do produto" required>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" placeholder="Qtd" min="1" value="1" required>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" placeholder="Valor unit." step="0.01" required>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger w-100" onclick="removeItem(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addItem()">
                        <i class="fas fa-plus me-2"></i>Adicionar Item
                    </button>
                    
                    <!-- Totais -->
                    <div class="bg-light p-3 rounded">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Desconto (R$)</label>
                                <input type="number" class="form-control" id="pedidoDesconto" value="0" min="0" step="0.01" onchange="calcularTotais()">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total do Pedido</label>
                                <h3 id="pedidoTotal" class="text-success mb-0">R$ 0,00</h3>
                                <small class="text-muted">Comissão: <span id="pedidoComissaoValor">R$ 0,00</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" id="pedidoObs" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePedido()">
                    <i class="fas fa-save me-2"></i>Salvar Pedido
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .card-custom {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .summary-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    
    .summary-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    
    .summary-info h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .summary-info p {
        margin: 0;
        color: #64748b;
        font-size: 0.85rem;
    }
    
    .table th {
        font-weight: 600;
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        border-bottom: 2px solid #f1f5f9;
    }
    
    .table td {
        vertical-align: middle;
        padding: 15px;
    }
    
    .pedido-id {
        font-weight: 600;
        color: #667eea;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-pendente {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .status-aprovado {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .status-entregue {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }
    
    .status-cancelado {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .btn-action {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    let pedidos = [];
    let clientes = [];
    let pedidoModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        pedidoModal = new bootstrap.Modal(document.getElementById('pedidoModal'));
        
        // Data padrão (mês atual)
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        document.getElementById('dataInicio').value = inicioMes.toISOString().split('T')[0];
        document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
        document.getElementById('pedidoData').value = hoje.toISOString().split('T')[0];
        
        loadClientes();
        loadPedidos();
        
        // Listener para calcular totais
        document.getElementById('itensPedido').addEventListener('input', calcularTotais);
        document.getElementById('pedidoComissao').addEventListener('input', calcularTotais);
    });
    
    async function loadClientes() {
        try {
            const response = await fetch('/api/clientes');
            clientes = await response.json();
            
            const select = document.getElementById('pedidoCliente');
            clientes.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.fantasia;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
        }
    }
    
    async function loadPedidos() {
        try {
            const response = await fetch('/api/pedidos');
            pedidos = await response.json();
            renderPedidos(pedidos);
            updateSummary(pedidos);
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            showToast('Erro ao carregar pedidos', 'danger');
        }
    }
    
    function renderPedidos(lista) {
        const tbody = document.getElementById('pedidosTable');
        
        if (lista.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum pedido encontrado</p>
                        <button class="btn btn-primary btn-sm" onclick="openPedidoModal()">
                            <i class="fas fa-plus me-2"></i>Criar primeiro pedido
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = lista.map(p => `
            <tr>
                <td>
                    <span class="pedido-id">#${p.id.slice(-6).toUpperCase()}</span>
                </td>
                <td>${p.clienteNome || 'Cliente'}</td>
                <td>${p.data ? new Date(p.data.seconds ? p.data.seconds * 1000 : p.data).toLocaleDateString('pt-BR') : '-'}</td>
                <td><strong>R$ ${(p.valorTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                <td class="text-success">R$ ${(p.comissaoValor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>
                    <span class="status-badge status-${p.status || 'pendente'}">
                        ${formatStatus(p.status || 'pendente')}
                    </span>
                </td>
                <td>
                    <button class="btn btn-outline-info btn-action me-1" onclick="viewPedido('${p.id}')" title="Ver">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success btn-action me-1" onclick="updateStatus('${p.id}')" title="Atualizar Status">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-action" onclick="cancelPedido('${p.id}')" title="Cancelar">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function updateSummary(lista) {
        const total = lista.length;
        const valorTotal = lista.reduce((sum, p) => sum + (p.valorTotal || 0), 0);
        const pendentes = lista.filter(p => p.status === 'pendente').length;
        const comissoes = lista.reduce((sum, p) => sum + (p.comissaoValor || 0), 0);
        
        document.getElementById('totalPedidos').textContent = total;
        document.getElementById('valorTotal').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('pendentes').textContent = pendentes;
        document.getElementById('comissoes').textContent = `R$ ${comissoes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    }
    
    function filterPedidos() {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const status = document.getElementById('filterStatusPedido').value;
        
        let filtered = pedidos.filter(p => {
            const pedidoDate = p.data ? new Date(p.data.seconds ? p.data.seconds * 1000 : p.data) : null;
            
            const matchDate = !dataInicio || !dataFim || !pedidoDate || 
                (pedidoDate >= new Date(dataInicio) && pedidoDate <= new Date(dataFim + 'T23:59:59'));
            const matchStatus = !status || p.status === status;
            
            return matchDate && matchStatus;
        });
        
        renderPedidos(filtered);
        updateSummary(filtered);
    }
    
    function openPedidoModal() {
        document.getElementById('pedidoForm').reset();
        document.getElementById('pedidoData').value = new Date().toISOString().split('T')[0];
        document.getElementById('pedidoComissao').value = 5;
        
        // Reset itens
        const container = document.getElementById('itensPedido');
        container.innerHTML = `
            <div class="item-row mb-3">
                <div class="row g-2">
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Descrição do produto" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" placeholder="Qtd" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Valor unit." step="0.01" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        calcularTotais();
        pedidoModal.show();
    }
    
    function addItem() {
        const container = document.getElementById('itensPedido');
        const itemHtml = `
            <div class="item-row mb-3">
                <div class="row g-2">
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Descrição do produto" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" placeholder="Qtd" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Valor unit." step="0.01" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHtml);
    }
    
    function removeItem(btn) {
        const items = document.querySelectorAll('.item-row');
        if (items.length > 1) {
            btn.closest('.item-row').remove();
            calcularTotais();
        } else {
            showToast('O pedido precisa ter pelo menos um item', 'warning');
        }
    }
    
    function calcularTotais() {
        const items = document.querySelectorAll('.item-row');
        let subtotal = 0;
        
        items.forEach(item => {
            const inputs = item.querySelectorAll('input');
            const qtd = parseFloat(inputs[1].value) || 0;
            const valor = parseFloat(inputs[2].value) || 0;
            subtotal += qtd * valor;
        });
        
        const desconto = parseFloat(document.getElementById('pedidoDesconto').value) || 0;
        const total = subtotal - desconto;
        const comissaoPercent = parseFloat(document.getElementById('pedidoComissao').value) || 0;
        const comissaoValor = total * (comissaoPercent / 100);
        
        document.getElementById('pedidoTotal').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('pedidoComissaoValor').textContent = `R$ ${comissaoValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    }
    
    async function savePedido() {
        const clienteId = document.getElementById('pedidoCliente').value;
        const data = document.getElementById('pedidoData').value;
        
        if (!clienteId || !data) {
            showToast('Selecione um cliente e data', 'warning');
            return;
        }
        
        // Coletar itens
        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            const descricao = inputs[0].value;
            const qtd = parseFloat(inputs[1].value) || 0;
            const valor = parseFloat(inputs[2].value) || 0;
            
            if (descricao && qtd > 0 && valor > 0) {
                items.push({ descricao, quantidade: qtd, valorUnitario: valor, total: qtd * valor });
            }
        });
        
        if (items.length === 0) {
            showToast('Adicione pelo menos um item ao pedido', 'warning');
            return;
        }
        
        const subtotal = items.reduce((sum, i) => sum + i.total, 0);
        const desconto = parseFloat(document.getElementById('pedidoDesconto').value) || 0;
        const valorTotal = subtotal - desconto;
        const comissaoPercent = parseFloat(document.getElementById('pedidoComissao').value) || 0;
        const comissaoValor = valorTotal * (comissaoPercent / 100);
        
        const pedidoData = {
            clienteId,
            data,
            itens: items,
            subtotal,
            desconto,
            valorTotal,
            comissaoPercent,
            comissaoValor,
            observacoes: document.getElementById('pedidoObs').value,
            status: 'pendente'
        };
        
        try {
            const response = await fetch('/api/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData)
            });
            
            if (response.ok) {
                pedidoModal.hide();
                showToast('Pedido criado com sucesso!', 'success');
                loadPedidos();
            } else {
                const error = await response.json();
                showToast(error.error || 'Erro ao criar pedido', 'danger');
            }
        } catch (error) {
            console.error('Erro ao salvar pedido:', error);
            showToast('Erro ao salvar pedido', 'danger');
        }
    }
    
    async function updateStatus(id) {
        const pedido = pedidos.find(p => p.id === id);
        if (!pedido) return;
        
        const statusFlow = {
            'pendente': 'aprovado',
            'aprovado': 'entregue',
            'entregue': 'entregue',
            'cancelado': 'cancelado'
        };
        
        const newStatus = statusFlow[pedido.status] || 'aprovado';
        
        if (!confirm(`Atualizar status para "${formatStatus(newStatus)}"?`)) return;
        
        try {
            const response = await fetch(`/api/pedidos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                showToast('Status atualizado!', 'success');
                loadPedidos();
            } else {
                showToast('Erro ao atualizar', 'danger');
            }
        } catch (error) {
            showToast('Erro ao atualizar', 'danger');
        }
    }
    
    async function cancelPedido(id) {
        if (!confirm('Tem certeza que deseja cancelar este pedido?')) return;
        
        try {
            const response = await fetch(`/api/pedidos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'cancelado' })
            });
            
            if (response.ok) {
                showToast('Pedido cancelado', 'success');
                loadPedidos();
            } else {
                showToast('Erro ao cancelar', 'danger');
            }
        } catch (error) {
            showToast('Erro ao cancelar', 'danger');
        }
    }
    
    function viewPedido(id) {
        const pedido = pedidos.find(p => p.id === id);
        if (!pedido) return;
        
        alert(`Pedido #${id.slice(-6)}\n\nCliente: ${pedido.clienteNome}\nValor: R$ ${pedido.valorTotal}\nStatus: ${pedido.status}`);
    }
    
    function exportPedidos() {
        const csv = [
            ['ID', 'Cliente', 'Data', 'Valor', 'Comissão', 'Status'].join(','),
            ...pedidos.map(p => [
                p.id.slice(-6),
                p.clienteNome || '',
                p.data ? new Date(p.data.seconds ? p.data.seconds * 1000 : p.data).toLocaleDateString('pt-BR') : '',
                p.valorTotal || 0,
                p.comissaoValor || 0,
                p.status || ''
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pedidos.csv';
        a.click();
    }
    
    function formatStatus(status) {
        const statuses = {
            'pendente': 'Pendente',
            'aprovado': 'Aprovado',
            'entregue': 'Entregue',
            'cancelado': 'Cancelado'
        };
        return statuses[status] || status;
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %}