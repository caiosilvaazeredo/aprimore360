{% extends "base.html" %}

{% block title %}Configurações - Gestão Comercial{% endblock %}
{% block page_title %}Configurações{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Settings Menu -->
        <div class="col-md-3">
            <div class="stat-card">
                <div class="nav flex-column nav-pills">
                    <button class="nav-link active text-start mb-2" data-bs-toggle="pill" data-bs-target="#perfil">
                        <i class="fas fa-user me-2"></i> Perfil
                    </button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#empresa">
                        <i class="fas fa-building me-2"></i> Empresa
                    </button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#notificacoes">
                        <i class="fas fa-bell me-2"></i> Notificações
                    </button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#integracao">
                        <i class="fas fa-plug me-2"></i> Integrações
                    </button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#seguranca">
                        <i class="fas fa-shield-alt me-2"></i> Segurança
                    </button>
                    <button class="nav-link text-start mb-2" data-bs-toggle="pill" data-bs-target="#backup">
                        <i class="fas fa-database me-2"></i> Backup
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Profile Settings -->
                <div class="tab-pane fade show active" id="perfil">
                    <div class="stat-card">
                        <h5 class="mb-4">Configurações do Perfil</h5>
                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo</label>
                                    <input type="text" class="form-control" id="nome" value="{{ user.nome if user else '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" value="{{ user.email if user else '' }}" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="telefone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Cargo</label>
                                    <input type="text" class="form-control" id="cargo" value="{{ user.cargo if user else '' }}">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Foto do Perfil</label>
                                    <input type="file" class="form-control" id="foto" accept="image/*">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-gradient">
                                <i class="fas fa-save"></i> Salvar Alterações
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Company Settings -->
                <div class="tab-pane fade" id="empresa">
                    <div class="stat-card">
                        <h5 class="mb-4">Configurações da Empresa</h5>
                        <form id="companyForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome da Empresa</label>
                                    <input type="text" class="form-control" id="empresaNome" value="{{ user.empresa if user else '' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" class="form-control" id="cnpj">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone Comercial</label>
                                    <input type="text" class="form-control" id="telefoneComercial">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email Comercial</label>
                                    <input type="email" class="form-control" id="emailComercial">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Endereço Completo</label>
                                    <textarea class="form-control" id="endereco" rows="3"></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Meta Mensal Padrão</label>
                                    <input type="number" class="form-control" id="metaPadrao" step="0.01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Comissão Padrão (%)</label>
                                    <input type="number" class="form-control" id="comissaoPadrao" step="0.01" min="0" max="100">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-gradient">
                                <i class="fas fa-save"></i> Salvar Configurações
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Notifications Settings -->
                <div class="tab-pane fade" id="notificacoes">
                    <div class="stat-card">
                        <h5 class="mb-4">Configurações de Notificações</h5>
                        <form id="notificationForm">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifEmail" checked>
                                <label class="form-check-label" for="notifEmail">
                                    Receber notificações por email
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifWhatsapp">
                                <label class="form-check-label" for="notifWhatsapp">
                                    Receber notificações por WhatsApp
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifPush" checked>
                                <label class="form-check-label" for="notifPush">
                                    Notificações push no navegador
                                </label>
                            </div>
                            
                            <hr>
                            
                            <h6 class="mb-3">Tipos de Notificações</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifNovoPedido" checked>
                                <label class="form-check-label" for="notifNovoPedido">
                                    Novos pedidos
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifMeta" checked>
                                <label class="form-check-label" for="notifMeta">
                                    Alertas de meta
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifCompromisso" checked>
                                <label class="form-check-label" for="notifCompromisso">
                                    Lembretes de compromissos
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notifRelatorio">
                                <label class="form-check-label" for="notifRelatorio">
                                    Relatórios diários
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-gradient mt-3">
                                <i class="fas fa-save"></i> Salvar Preferências
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Integration Settings -->
                <div class="tab-pane fade" id="integracao">
                    <div class="stat-card">
                        <h5 class="mb-4">Integrações</h5>
                        
                        <div class="integration-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fab fa-google text-danger me-2"></i>
                                        Google Calendar
                                    </h6>
                                    <small class="text-muted">Sincronize seus compromissos com o Google Calendar</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="connectGoogle()">
                                    Conectar
                                </button>
                            </div>
                        </div>
                        
                        <div class="integration-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fab fa-whatsapp text-success me-2"></i>
                                        WhatsApp Business
                                    </h6>
                                    <small class="text-muted">Envie mensagens automáticas para clientes</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="connectWhatsApp()">
                                    Conectar
                                </button>
                            </div>
                        </div>
                        
                        <div class="integration-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-file-invoice text-info me-2"></i>
                                        Sistema ERP
                                    </h6>
                                    <small class="text-muted">Integre com seu sistema ERP</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="connectERP()">
                                    Configurar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div class="tab-pane fade" id="seguranca">
                    <div class="stat-card">
                        <h5 class="mb-4">Segurança</h5>
                        
                        <form id="passwordForm">
                            <h6 class="mb-3">Alterar Senha</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Senha Atual</label>
                                    <input type="password" class="form-control" id="senhaAtual">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nova Senha</label>
                                    <input type="password" class="form-control" id="novaSenha">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Confirmar Nova Senha</label>
                                    <input type="password" class="form-control" id="confirmarSenha">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-gradient">
                                <i class="fas fa-key"></i> Alterar Senha
                            </button>
                        </form>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">Autenticação em Dois Fatores</h6>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="twoFactor">
                            <label class="form-check-label" for="twoFactor">
                                Ativar autenticação em dois fatores
                            </label>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">Sessões Ativas</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <tbody>
                                    <tr>
                                        <td>
                                            <i class="fas fa-desktop me-2"></i>
                                            Chrome - Windows
                                        </td>
                                        <td class="text-muted">Há 2 horas</td>
                                        <td>
                                            <span class="badge bg-success">Atual</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Backup Settings -->
                <div class="tab-pane fade" id="backup">
                    <div class="stat-card">
                        <h5 class="mb-4">Backup e Restauração</h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Backups automáticos são realizados diariamente às 03:00 AM
                        </div>
                        
                        <h6 class="mb-3">Último Backup</h6>
                        <p class="text-muted">{{ "Hoje" }} às 03:00 AM - 2.3 MB</p>
                        
                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-gradient" onclick="createBackup()">
                                <i class="fas fa-download"></i> Fazer Backup Agora
                            </button>
                            <button class="btn btn-outline-primary" onclick="restoreBackup()">
                                <i class="fas fa-upload"></i> Restaurar Backup
                            </button>
                        </div>
                        
                        <h6 class="mb-3">Histórico de Backups</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tamanho</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>12/01/2025 03:00</td>
                                        <td>2.3 MB</td>
                                        <td><span class="badge bg-success">Sucesso</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load Profile
    async function loadProfile() {
        try {
            const response = await fetch('/api/usuario/perfil');
            const data = await response.json();
            
            // Fill form with user data
            document.getElementById('nome').value = data.nome || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('telefone').value = data.telefone || '';
            document.getElementById('cargo').value = data.cargo || '';
            
        } catch (error) {
            console.error('Erro ao carregar perfil:', error);
        }
    }
    
    // Save Profile
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const profileData = {
            nome: document.getElementById('nome').value,
            telefone: document.getElementById('telefone').value,
            cargo: document.getElementById('cargo').value
        };
        
        try {
            showLoading();
            
            const response = await fetch('/api/usuario/perfil', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(profileData)
            });
            
            if (response.ok) {
                Swal.fire('Sucesso', 'Perfil atualizado com sucesso!', 'success');
            } else {
                Swal.fire('Erro', 'Erro ao atualizar perfil', 'error');
            }
            
        } catch (error) {
            console.error('Erro ao salvar perfil:', error);
            Swal.fire('Erro', 'Erro ao salvar perfil', 'error');
        } finally {
            hideLoading();
        }
    });
    
    // Change Password
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const senhaAtual = document.getElementById('senhaAtual').value;
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;
        
        if (novaSenha !== confirmarSenha) {
            Swal.fire('Erro', 'As senhas não coincidem', 'error');
            return;
        }
        
        // Implementation for password change
        Swal.fire('Info', 'Alteração de senha em desenvolvimento', 'info');
    });
    
    // Integration Functions
    function connectGoogle() {
        Swal.fire('Info', 'Integração com Google Calendar em desenvolvimento', 'info');
    }
    
    function connectWhatsApp() {
        Swal.fire('Info', 'Integração com WhatsApp em desenvolvimento', 'info');
    }
    
    function connectERP() {
        Swal.fire('Info', 'Integração com ERP em desenvolvimento', 'info');
    }
    
    // Backup Functions
    function createBackup() {
        Swal.fire('Info', 'Criação de backup em desenvolvimento', 'info');
    }
    
    function restoreBackup() {
        Swal.fire('Info', 'Restauração de backup em desenvolvimento', 'info');
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}